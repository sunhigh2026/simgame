// ========================================
// ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ & ãƒ­ã‚¸ãƒƒã‚¯
// ========================================

export const CARD_TEMPLATES = [
  // === å–¶æ¥­ç³» ===
  {
    id: 'sales_cold',
    name: 'é£›ã³è¾¼ã¿å–¶æ¥­',
    category: 'sales',
    categoryLabel: 'å–¶æ¥­',
    icon: 'ðŸš¶',
    description: 'ç‰‡ã£ç«¯ã‹ã‚‰é›»è©±ã—ã¦ã‚¢ãƒã‚’å–ã‚‹ã€‚æ³¥è‡­ã„ãŒåŸºæœ¬ã€‚',
    cost: 0,
    revenueMin: 50000,
    revenueMax: 200000,
    failRate: 0.40,
    failText: 'å…¨æ»…ã€‚ã‚¢ãƒã™ã‚‰å–ã‚Œãªã‹ã£ãŸã€‚',
    successText: '1ä»¶ç²å¾—ï¼',
    rarity: 1,
    count: 4,
    period: 1,
  },
  {
    id: 'sales_network',
    name: 'äº¤æµä¼šã«å‚åŠ ',
    category: 'sales',
    categoryLabel: 'å–¶æ¥­',
    icon: 'ðŸ¤',
    description: 'ç•°æ¥­ç¨®äº¤æµä¼šã§ååˆºã‚’é…ã‚Šã¾ãã‚‹ã€‚',
    cost: 30000,
    revenueMin: 100000,
    revenueMax: 300000,
    failRate: 0.30,
    failText: 'ååˆºäº¤æ›ã ã‘ã§çµ‚ã‚ã£ãŸã€‚',
    successText: 'äº¤æµä¼šã§è¦‹è¾¼ã¿å®¢ã‚’è¦‹ã¤ã‘ãŸï¼',
    rarity: 1,
    count: 3,
    period: 1,
  },
  {
    id: 'sales_sns',
    name: 'SNSã§ç™ºä¿¡',
    category: 'sales',
    categoryLabel: 'å–¶æ¥­',
    icon: 'ðŸ“±',
    description: 'å®Ÿç¸¾ã‚„çŸ¥è¦‹ã‚’æŠ•ç¨¿ã€‚ã˜ã‚ã˜ã‚åŠ¹ã„ã¦ãã‚‹ã€‚',
    cost: 0,
    revenueMin: 0,
    revenueMax: 150000,
    failRate: 0.55,
    failText: 'ã„ã„ã­3ä»¶ã€‚åå¿œãªã—ã€‚',
    successText: 'æŠ•ç¨¿ãŒãƒã‚ºã£ãŸï¼å•ã„åˆã‚ã›ãŒæ¥ãŸï¼',
    rarity: 1,
    count: 3,
    cumulative: true,
    cumulativeBonus: 20000,
    cumulativeBonusLabel: 'SNSè“„ç©åŠ¹æžœ',
    period: 1,
  },
  {
    id: 'sales_referral',
    name: 'ç´¹ä»‹å–¶æ¥­',
    category: 'sales',
    categoryLabel: 'å–¶æ¥­',
    icon: 'ðŸ’¬',
    description: 'æ—¢å­˜å®¢ã‚„çŸ¥äººã‹ã‚‰ã®ç´¹ä»‹ã€‚ä¿¡ç”¨ãŒãªã„ã¨æ¥ãªã„ã€‚',
    cost: 0,
    revenueMin: 200000,
    revenueMax: 500000,
    failRate: 0.20,
    failText: 'ç´¹ä»‹å…ˆã¨æ¡ä»¶ãŒåˆã‚ãªã‹ã£ãŸã€‚',
    successText: 'ç´¹ä»‹æ¡ˆä»¶ã‚’å—æ³¨ï¼ä¿¡é ¼ã®ãŠã‹ã’ã ã€‚',
    rarity: 2,
    count: 2,
    period: 2,
    requirement: { creditScore: 30 },
    requirementText: 'ä¿¡ç”¨ã‚¹ã‚³ã‚¢30ä»¥ä¸Šã§è§£æ”¾',
  },
  {
    id: 'sales_enterprise',
    name: 'å¤§æ‰‹ã«ææ¡ˆ',
    category: 'sales',
    categoryLabel: 'å–¶æ¥­',
    icon: 'ðŸ¢',
    description: 'å¤§æ‰‹ä¼æ¥­ã«DMã€‚å½“ãŸã‚Œã°ãƒ‡ã‚«ã„ã€‚',
    cost: 50000,
    revenueMin: 500000,
    revenueMax: 2000000,
    failRate: 0.60,
    failText: 'ææ¡ˆæ›¸ã™ã‚‰è¦‹ã¦ã‚‚ã‚‰ãˆãªã‹ã£ãŸã€‚',
    successText: 'å¤§æ‰‹æ¡ˆä»¶ã‚’å—æ³¨ï¼ï¼ãƒ‡ã‚«ã„ï¼ï¼',
    rarity: 3,
    count: 1,
    period: 2,
  },
  {
    id: 'sales_repeat',
    name: 'ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼å¯¾å¿œ',
    category: 'sales',
    categoryLabel: 'å–¶æ¥­',
    icon: 'ðŸ”„',
    description: 'æ—¢å­˜å®¢ã«è¿½åŠ ææ¡ˆã€‚å®‰å®šã®å£²ä¸Šã€‚',
    cost: 0,
    revenueMin: 150000,
    revenueMax: 350000,
    failRate: 0.10,
    failText: 'ä»Šã¯è¿½åŠ ã®äºˆç®—ãŒãªã„ãã†ã ã€‚',
    successText: 'ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼ã‹ã‚‰è¿½åŠ å—æ³¨ï¼',
    rarity: 2,
    count: 2,
    period: 2,
    requirement: { totalRevenue: 5000000 },
    requirementText: 'ç´¯è¨ˆå£²ä¸ŠÆ³500ä¸‡ä»¥ä¸Šã§è§£æ”¾',
  },

  // === æŠ•è³‡ç³» ===
  {
    id: 'invest_ad',
    name: 'SNSåºƒå‘Š',
    category: 'invest',
    categoryLabel: 'æŠ•è³‡',
    icon: 'ðŸ“¢',
    description: 'åºƒå‘Šã‚’æ‰“ã£ã¦é›†å®¢ã™ã‚‹ã€‚å³åŠ¹æ€§ã‚ã‚Šã€‚',
    cost: 150000,
    revenueMin: 200000,
    revenueMax: 600000,
    failRate: 0.20,
    failText: 'åºƒå‘Šè²»ã ã‘æ¶ˆãˆãŸâ€¦ã€‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®šãŒç”˜ã‹ã£ãŸã€‚',
    successText: 'åºƒå‘ŠçµŒç”±ã§å•ã„åˆã‚ã›ãŒå¢—ãˆãŸï¼',
    rarity: 1,
    count: 2,
    period: 1,
  },
  {
    id: 'invest_website',
    name: 'Webã‚µã‚¤ãƒˆä½œæˆ',
    category: 'invest',
    categoryLabel: 'æŠ•è³‡',
    icon: 'ðŸŒ',
    description: 'ä¼šç¤¾ã®Webã‚µã‚¤ãƒˆã‚’ä½œã‚‹ã€‚ä¿¡ç”¨ã¨é›†å®¢ã®åŸºç›¤ã€‚',
    cost: 300000,
    permanent: true,
    permanentEffect: { revenueBase: 50000, creditScore: 5 },
    permanentLabel: 'æ¯Žæœˆã®å£²ä¸Šãƒ™ãƒ¼ã‚¹+Æ³5ä¸‡ / ä¿¡ç”¨+5',
    failRate: 0,
    rarity: 2,
    count: 1,
    period: 1,
    unique: true,
  },
  {
    id: 'invest_office',
    name: 'ã‚ªãƒ•ã‚£ã‚¹ã‚’å€Ÿã‚Šã‚‹',
    category: 'invest',
    categoryLabel: 'æŠ•è³‡',
    icon: 'ðŸ ',
    description: 'è‡ªå®…ã‹ã‚‰è„±å‡ºã€‚ä¿¡ç”¨UPã ãŒå›ºå®šè²»ãŒé‡ã„ã€‚',
    cost: 500000,
    permanent: true,
    permanentEffect: { creditScore: 10, monthlyExpense: 150000 },
    permanentLabel: 'ä¿¡ç”¨+10 / æ¯Žæœˆå›ºå®šè²»+Æ³15ä¸‡',
    failRate: 0,
    rarity: 2,
    count: 1,
    period: 1,
    unique: true,
  },
  {
    id: 'invest_equipment',
    name: 'è¨­å‚™æŠ•è³‡',
    category: 'invest',
    categoryLabel: 'æŠ•è³‡',
    icon: 'ðŸ–¥ï¸',
    description: 'è‰¯ã„æ©Ÿæã‚’æƒãˆã‚‹ã€‚å“è³ªUPã§å˜ä¾¡ãŒä¸ŠãŒã‚‹ã€‚',
    cost: 800000,
    permanent: true,
    permanentEffect: { revenueMultiplier: 1.10 },
    permanentLabel: 'å£²ä¸Š+10%',
    failRate: 0,
    rarity: 2,
    count: 1,
    period: 2,
    unique: true,
  },

  // === äººæç³» ===
  {
    id: 'hr_parttime',
    name: 'ãƒã‚¤ãƒˆã‚’é›‡ã†',
    category: 'hr',
    categoryLabel: 'äººæ',
    icon: 'ðŸ‘¤',
    description: 'ã¾ãšã¯ãƒã‚¤ãƒˆã‹ã‚‰ã€‚å£²ä¸Šã®å¤©äº•ãŒä¸ŠãŒã‚‹ã€‚',
    cost: 50000,
    permanent: true,
    permanentEffect: { revenueCap: 300000, monthlyExpense: 120000 },
    permanentLabel: 'å£²ä¸Šä¸Šé™+Æ³30ä¸‡/æœˆ / äººä»¶è²»Æ³12ä¸‡/æœˆ',
    failRate: 0.10,
    failText: 'é¢æŽ¥ã—ãŸã‘ã©è¾žé€€ã•ã‚ŒãŸã€‚æŽ¡ç”¨è²»ã ã‘æ¶ˆãˆãŸâ€¦ã€‚',
    successText: 'ãƒã‚¤ãƒˆã®ã‚¹ã‚ºã‚­ã•ã‚“ãŒå…¥ç¤¾ã—ãŸï¼',
    rarity: 1,
    count: 2,
    period: 1,
    addsEmployee: {
      name: 'ã‚¹ã‚ºã‚­',
      type: 'parttime',
      baseSalary: 120000,
      ability: 'B',
      satisfaction: 60,
    },
  },
  {
    id: 'hr_fulltime',
    name: 'æ­£ç¤¾å“¡ã‚’é›‡ã†',
    category: 'hr',
    categoryLabel: 'äººæ',
    icon: 'ðŸ‘”',
    description: 'æ­£ç¤¾å“¡ã€‚èƒ½åŠ›ã¯é«˜ã„ãŒå›ºå®šè²»ãŒé‡ã„ã€‚',
    cost: 100000,
    permanent: true,
    permanentEffect: { revenueCap: 600000, monthlyExpense: 280000 },
    permanentLabel: 'å£²ä¸Šä¸Šé™+Æ³60ä¸‡/æœˆ / äººä»¶è²»Æ³28ä¸‡/æœˆ',
    failRate: 0.05,
    failText: 'å†…å®šã‚’å‡ºã—ãŸãŒè¾žé€€ã•ã‚ŒãŸã€‚',
    successText: 'æ­£ç¤¾å“¡ã®ãƒ¤ãƒžãƒ€ã•ã‚“ãŒå…¥ç¤¾ã—ãŸï¼',
    rarity: 2,
    count: 1,
    period: 2,
    addsEmployee: {
      name: 'ãƒ¤ãƒžãƒ€',
      type: 'fulltime',
      baseSalary: 220000,
      ability: 'A',
      satisfaction: 70,
    },
  },
  {
    id: 'hr_outsource',
    name: 'å¤–æ³¨ã«ä¾é ¼',
    category: 'hr',
    categoryLabel: 'äººæ',
    icon: 'ðŸ“‹',
    description: 'ä»Šæœˆã ã‘å¤–æ³¨ã§å¢—å“¡ã€‚ç¶™ç¶šã‚³ã‚¹ãƒˆãªã—ã€‚',
    cost: 200000,
    revenueMin: 0,
    revenueMax: 0,
    revenueCap: 500000,
    failRate: 0.15,
    failText: 'å¤–æ³¨å…ˆã®å“è³ªãŒå¾®å¦™ã ã£ãŸâ€¦ã€‚æ‰‹ç›´ã—ã«æ™‚é–“ã‚’å–ã‚‰ã‚ŒãŸã€‚',
    successText: 'å¤–æ³¨ã§ä»Šæœˆã®ã‚­ãƒ£ãƒ‘ãŒå¢—ãˆãŸï¼',
    rarity: 1,
    count: 2,
    period: 1,
    tempEffect: { revenueCap: 500000 },
  },

  // === ç¯€ç¨Žç³» ===
  {
    id: 'tax_smallbiz',
    name: 'å°å•†äººç©ç«‹',
    category: 'tax',
    categoryLabel: 'ç¯€ç¨Ž',
    icon: 'ðŸ¦',
    description: 'æœˆÆ³7ä¸‡ã®ç©ç«‹ã§å¹´é–“Æ³84ä¸‡ã‚’åˆ©ç›Šã‹ã‚‰æŽ§é™¤ã€‚å°†æ¥æˆ»ã£ã¦ãã‚‹ã€‚',
    cost: 0,
    permanent: true,
    permanentEffect: { monthlyExpense: 70000, taxDeduction: 840000 },
    permanentLabel: 'æœˆÆ³7ä¸‡ç©ç«‹ / å¹´Æ³84ä¸‡ã®åˆ©ç›ŠæŽ§é™¤',
    failRate: 0,
    rarity: 2,
    count: 1,
    period: 2,
    unique: true,
  },
  {
    id: 'tax_safety',
    name: 'å®‰å…¨å…±æ¸ˆæ©Ÿæ§‹',
    category: 'tax',
    categoryLabel: 'ç¯€ç¨Ž',
    icon: 'ðŸ›¡ï¸',
    description: 'æœˆÆ³20ä¸‡ã§å¹´é–“Æ³240ä¸‡ã‚’çµŒè²»åŒ–ã€‚å–å¼•å…ˆå€’ç”£æ™‚ã®ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒãƒƒãƒˆã€‚',
    cost: 0,
    permanent: true,
    permanentEffect: { monthlyExpense: 200000, taxDeduction: 2400000 },
    permanentLabel: 'æœˆÆ³20ä¸‡ç©ç«‹ / å¹´Æ³240ä¸‡ã‚’çµŒè²»åŒ–',
    failRate: 0,
    rarity: 2,
    count: 1,
    period: 2,
    unique: true,
  },
  {
    id: 'tax_bonus',
    name: 'æ±ºç®—è³žä¸Ž',
    category: 'tax',
    categoryLabel: 'ç¯€ç¨Ž',
    icon: 'ðŸŽ',
    description: 'å¾“æ¥­å“¡ã«ãƒœãƒ¼ãƒŠã‚¹ã‚’å‡ºã—ã¦çµŒè²»ã«ã™ã‚‹ã€‚æ±ºç®—æœˆã®ã¿ä½¿ç”¨å¯ã€‚',
    cost: 0,
    failRate: 0,
    rarity: 2,
    count: 1,
    period: 2,
    requirement: { hasEmployees: true },
    requirementText: 'å¾“æ¥­å“¡1äººä»¥ä¸Šã§è§£æ”¾',
    settlementOnly: true,
    interactive: true,
  },

  // === ç‰¹æ®Šç³» ===
  {
    id: 'special_loan',
    name: 'èžè³‡ç”³è«‹',
    category: 'special',
    categoryLabel: 'ç‰¹æ®Š',
    icon: 'ðŸ›ï¸',
    description: 'éŠ€è¡Œã‹ã‚‰å€Ÿã‚Šã‚‹ã€‚å¯©æŸ»ã‚ã‚Šã€‚',
    cost: 0,
    failRate: 0.40,
    failText: 'å¯©æŸ»ã®çµæžœã€ä»Šå›žã¯è¦‹é€ã‚Šã¨ãªã‚Šã¾ã—ãŸã€‚',
    successText: 'èžè³‡ãŒé€šã£ãŸï¼',
    rarity: 3,
    count: 1,
    period: 2,
    interactive: true,
  },
  {
    id: 'special_subsidy',
    name: 'åŠ©æˆé‡‘ç”³è«‹',
    category: 'special',
    categoryLabel: 'ç‰¹æ®Š',
    icon: 'ðŸ“',
    description: 'å›½ã®åŠ©æˆé‡‘ã«å¿œå‹Ÿã€‚é€šã‚Œã°è¿”æ¸ˆä¸è¦ã®ãŠé‡‘ãŒå…¥ã‚‹ã€‚',
    cost: 0,
    revenueMin: 500000,
    revenueMax: 1000000,
    failRate: 0.50,
    failText: 'ä¸æŽ¡æŠžã€‚æ›¸é¡žãŒè¶³ã‚Šãªã‹ã£ãŸâ€¦ã€‚',
    successText: 'åŠ©æˆé‡‘ã«æŽ¡æŠžã•ã‚ŒãŸï¼è¿”æ¸ˆä¸è¦ï¼',
    rarity: 3,
    count: 1,
    period: 2,
  },

  // === ä¼‘æ¯ ===
  {
    id: 'rest',
    name: 'ä¼‘ã‚€',
    category: 'rest',
    categoryLabel: 'ä¼‘æ¯',
    icon: 'ðŸ–ï¸',
    description: 'ä½•ã‚‚ã—ãªã„ã€‚ã§ã‚‚ä½“åŠ›ã¯æˆ»ã‚‹ã€‚',
    cost: 0,
    failRate: 0,
    rarity: 1,
    count: 2,
    period: 1,
    restoreStamina: 20,
  },
];

// å±±æœ­ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆæœŸã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
export function buildDeck(period, gameState) {
  const deck = [];
  for (const tmpl of CARD_TEMPLATES) {
    if (tmpl.period > period) continue;
    if (tmpl.unique && gameState.usedUniqueCards.includes(tmpl.id)) continue;
    if (tmpl.requirement) {
      if (tmpl.requirement.creditScore && gameState.creditScore < tmpl.requirement.creditScore) continue;
      if (tmpl.requirement.totalRevenue && gameState.totalRevenue < tmpl.requirement.totalRevenue) continue;
      if (tmpl.requirement.hasEmployees && gameState.employees.length === 0) continue;
    }
    for (let i = 0; i < tmpl.count; i++) {
      deck.push({ ...tmpl, instanceId: `${tmpl.id}_${i}_${Math.random().toString(36).slice(2, 8)}` });
    }
  }
  return shuffle(deck);
}

// æ‰‹æœ­ã‚’å¼•ã
export function drawHand(deck, count = 5) {
  const hand = [];
  for (let i = 0; i < count && deck.length > 0; i++) {
    hand.push(deck.pop());
  }
  return hand;
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}